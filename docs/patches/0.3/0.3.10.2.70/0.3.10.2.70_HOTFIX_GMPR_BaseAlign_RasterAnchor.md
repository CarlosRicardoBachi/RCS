# RCS 0.3.10.2.70 — HOTFIX GMPR Base Align + Raster Anchor

Fecha: 2026-02-05

## Problema

Al importar un `.gmpr`:

1) El **SVG base** (embebido) se renderizaba con el pipeline de *preview* (máximo ~240px), por lo que quedaba **fuera de escala** respecto al canvas. Resultado: el raster no se alinea visualmente.

2) El **raster** podía salir **gigante** porque `sx/sy` a veces son factores relativos (~1.0) y no mm/px absolutos.

3) El **anclaje** del raster podía venir como centro (x/y = centro), pero RCS asume top-left.

## Solución

### 1) Base SVG GMPR a escala real del canvas
- Nuevo render dedicado: el SVG se rasteriza al tamaño físico del canvas (`project.canvas_mm`).
- Se clampa la resolución máxima con `RCS_GMPR_BASE_MAX_PX` (default 4096) para evitar imágenes enormes, manteniendo escala correcta vía `mm_por_px_rendered`.
- El base SVG es **seleccionable** solo para inspección (tooltip con tamaño), no es movible ni se guarda como objeto.

### 2) Raster: escala + anclaje robustos
- Se lee el tamaño real del PNG desde IHDR (sin dependencias).
- Si hay tamaño de PNG + tamaño de canvas: se evalúan 4 candidatos:
  - ABS (sx/sy como mm/px) vs REL (sx/sy como factor)
  - TOP-LEFT vs CENTER (x/y como esquina o como centro)
- Se elige el candidato con menor penalización por quedar fuera del canvas (bbox scoring).
- Si falta información: se mantiene el fallback anterior por rangos (compatibilidad).

## Archivos tocados
- `rcs/ui/canvas_view.py`
- `rcs/core/gmpr_io.py`
- `rcs/core/version.py`
- `docs/patches/index.md`
- `docs/CHANGELOG.md`

## Pruebas manuales

1) `python -m rcs.app` → debe mostrar `v0.3.10.2.70`.

2) Archivo → Importar GMPR…
- El SVG base debe verse ocupando el área del canvas (misma escala que objetos).
- El/los raster(s) deben alinearse con el SVG base.
- El raster NO debe aparecer gigante cuando `sx/sy ≈ 1.0`.

3) Interacción
- Click en el SVG base → se selecciona (tooltip con tamaño), no se mueve.
- Click en raster → se selecciona el raster normalmente.

4) Persistencia
- Guardar / reabrir → objetos mantienen posición y escala (sin “teletransporte”).
